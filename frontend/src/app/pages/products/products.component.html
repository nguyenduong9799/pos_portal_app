<div class="container mx-auto p-6">
  <!-- Header -->
  <div class="flex justify-between items-center mb-6">
    <h1 class="text-3xl font-bold text-gray-800">Products Management</h1>
    <button class="btn btn-primary" (click)="openCreateModal()">
      <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
      </svg>
      Add Product
    </button>
  </div>

  <!-- Error Alert -->
  @if (error()) {
    <div class="alert alert-error mb-4">
      <svg xmlns="http://www.w3.org/2000/svg" class="stroke-current shrink-0 h-6 w-6" fill="none" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z" />
      </svg>
      <span>{{ error() }}</span>
    </div>
  }

  <!-- Loading Indicator -->
  @if (isLoading()) {
    <div class="flex justify-center items-center py-8">
      <span class="loading loading-spinner loading-lg"></span>
    </div>
  } @else {
    <!-- Products Table -->
    <div class="overflow-x-auto">
      <table class="table table-zebra w-full">
        <thead>
          <tr>
            <th>SKU</th>
            <th>Name</th>
            <th>Price</th>
            <th>Cost</th>
            <th>Stock</th>
            <th>Status</th>
            <th>Stock Status</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          @for (product of products(); track product.id) {
            <tr>
              <td class="font-mono">{{ product.sku }}</td>
              <td>
                <div>
                  <div class="font-bold">{{ product.name }}</div>
                  @if (product.description) {
                    <div class="text-sm opacity-50">{{ product.description }}</div>
                  }
                </div>
              </td>
              <td class="font-semibold">${{ product.price.toFixed(2) }}</td>
              <td>${{ product.cost.toFixed(2) }}</td>
              <td>
                <div class="text-center">
                  <div class="font-semibold">{{ product.stockQuantity }}</div>
                  <div class="text-xs text-gray-500">Min: {{ product.minimumStock }}</div>
                </div>
              </td>
              <td>
                <div class="badge" [class]="product.status === 'active' ? 'badge-success' : 'badge-error'">
                  {{ product.status }}
                </div>
              </td>
              <td>
                <div class="badge" [class]="getStockStatusClass(product)">
                  {{ getStockStatus(product) }}
                </div>
              </td>
              <td>
                <div class="flex gap-2">
                  <button class="btn btn-sm btn-outline btn-primary" (click)="openEditModal(product)">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                    </svg>
                  </button>
                  <button class="btn btn-sm btn-outline btn-error" (click)="deleteProduct(product.id!)">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                    </svg>
                  </button>
                </div>
              </td>
            </tr>
          } @empty {
            <tr>
              <td colspan="8" class="text-center py-8 text-gray-500">
                No products found. Add your first product to get started.
              </td>
            </tr>
          }
        </tbody>
      </table>
    </div>

    <!-- Pagination Controls -->
    @if (paginationMeta()) {
      <div class="flex flex-col md:flex-row justify-between items-center mt-6 gap-4">
        <!-- Items per page selector -->
        <div class="flex items-center gap-2">
          <span class="text-sm text-gray-600">Items per page:</span>
          <select 
            class="select select-bordered select-sm" 
            [value]="pageSize()" 
            (change)="changePageSize(+($any($event.target).value))"
          >
            @for (size of pageSizeOptions; track size) {
              <option [value]="size">{{ size }}</option>
            }
          </select>
        </div>

        <!-- Pagination info -->
        <div class="text-sm text-gray-600">
          Showing {{ (currentPage() - 1) * pageSize() + 1 }} - {{ Math.min(currentPage() * pageSize(), totalItems()) }} 
          of {{ totalItems() }} items
        </div>

        <!-- Pagination buttons -->
        <div class="join">
          <button 
            class="join-item btn btn-sm"
            [disabled]="!paginationMeta()?.hasPreviousPage"
            (click)="previousPage()"
          >
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
            </svg>
            Previous
          </button>

          @for (pageNum of getPageNumbers(); track pageNum) {
            <button 
              class="join-item btn btn-sm"
              [class.btn-active]="pageNum === currentPage()"
              (click)="goToPage(pageNum)"
            >
              {{ pageNum }}
            </button>
          }

          <button 
            class="join-item btn btn-sm"
            [disabled]="!paginationMeta()?.hasNextPage"
            (click)="nextPage()"
          >
            Next
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
            </svg>
          </button>
        </div>
      </div>
    }
  }

  <!-- Modal -->
  @if (showModal()) {
    <div class="modal modal-open">
      <div class="modal-box w-11/12 max-w-2xl">
        <h3 class="font-bold text-lg mb-4">
          {{ editingProduct() ? 'Edit Product' : 'Add New Product' }}
        </h3>
        
        <form [formGroup]="productForm" (ngSubmit)="onSubmit()">
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <!-- Name -->
            <div class="form-control">
              <label class="label">
                <span class="label-text">Name *</span>
              </label>
              <input 
                type="text" 
                placeholder="Product name" 
                class="input input-bordered"
                formControlName="name"
                [class.input-error]="productForm.get('name')?.invalid && productForm.get('name')?.touched"
              />
            </div>

            <!-- SKU -->
            <div class="form-control">
              <label class="label">
                <span class="label-text">SKU *</span>
              </label>
              <input 
                type="text" 
                placeholder="Product SKU" 
                class="input input-bordered font-mono"
                formControlName="sku"
                [class.input-error]="productForm.get('sku')?.invalid && productForm.get('sku')?.touched"
              />
            </div>

            <!-- Price -->
            <div class="form-control">
              <label class="label">
                <span class="label-text">Price *</span>
              </label>
              <input 
                type="number" 
                step="0.01"
                placeholder="0.00" 
                class="input input-bordered"
                formControlName="price"
                [class.input-error]="productForm.get('price')?.invalid && productForm.get('price')?.touched"
              />
            </div>

            <!-- Cost -->
            <div class="form-control">
              <label class="label">
                <span class="label-text">Cost *</span>
              </label>
              <input 
                type="number" 
                step="0.01"
                placeholder="0.00" 
                class="input input-bordered"
                formControlName="cost"
                [class.input-error]="productForm.get('cost')?.invalid && productForm.get('cost')?.touched"
              />
            </div>

            <!-- Stock Quantity -->
            <div class="form-control">
              <label class="label">
                <span class="label-text">Stock Quantity *</span>
              </label>
              <input 
                type="number" 
                placeholder="0" 
                class="input input-bordered"
                formControlName="stockQuantity"
                [class.input-error]="productForm.get('stockQuantity')?.invalid && productForm.get('stockQuantity')?.touched"
              />
            </div>

            <!-- Minimum Stock -->
            <div class="form-control">
              <label class="label">
                <span class="label-text">Minimum Stock *</span>
              </label>
              <input 
                type="number" 
                placeholder="0" 
                class="input input-bordered"
                formControlName="minimumStock"
                [class.input-error]="productForm.get('minimumStock')?.invalid && productForm.get('minimumStock')?.touched"
              />
            </div>

            <!-- Status -->
            <div class="form-control">
              <label class="label">
                <span class="label-text">Status *</span>
              </label>
              <select class="select select-bordered" formControlName="status">
                <option value="active">Active</option>
                <option value="inactive">Inactive</option>
              </select>
            </div>

            <!-- Image URL -->
            <div class="form-control">
              <label class="label">
                <span class="label-text">Image URL</span>
              </label>
              <input 
                type="url" 
                placeholder="https://..." 
                class="input input-bordered"
                formControlName="imageUrl"
              />
            </div>
          </div>

          <!-- Description -->
          <div class="form-control mt-4">
            <label class="label">
              <span class="label-text">Description</span>
            </label>
            <textarea 
              class="textarea textarea-bordered h-24" 
              placeholder="Product description"
              formControlName="description"
              [class.textarea-error]="productForm.get('description')?.invalid && productForm.get('description')?.touched"
            ></textarea>
          </div>

          <div class="modal-action">
            <button type="button" class="btn btn-ghost" (click)="closeModal()">Cancel</button>
            <button 
              type="submit" 
              class="btn btn-primary" 
              [disabled]="productForm.invalid || isLoading()"
              [class.loading]="isLoading()"
            >
              {{ editingProduct() ? 'Update' : 'Create' }}
            </button>
          </div>
        </form>
      </div>
    </div>
  }
</div>
